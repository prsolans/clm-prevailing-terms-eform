<!-- Include this in your HTML -->
<style data-emotion="css-global" data-s="">
    @font-face {
        font-display: block;
        font-family: '7_Docusign';
        font-style: normal;
        font-weight: 400;
        src: url('https://www.docusign.com/assets/fonts/7_Docusign.woff') format('woff');
    }

    @font-face {
        font-display: block;
        font-family: 'DSIndigo';
        font-style: normal;
        font-weight: 300;
        src: url('https://www.docusign.com/assets/fonts/dsindigo-light.woff2') format('woff2'), url('https://www.docusign.com/assets/fonts/dsindigo-light.woff') format('woff');
    }

    @font-face {
        font-display: block;
        font-family: 'DSIndigo';
        font-style: italic;
        font-weight: 300;
        src: url('https://www.docusign.com/assets/fonts/dsindigo-lightitalic.woff2') format('woff2'), url('https://www.docusign.com/assets/fonts/dsindigo-lightitalic.woff') format('woff');
    }

    @font-face {
        font-display: block;
        font-family: 'DSIndigo';
        font-style: normal;
        font-weight: 400;
        src: url('https://www.docusign.com/assets/fonts/dsindigo-regular.woff2') format('woff2'), url('https://www.docusign.com/assets/fonts/dsindigo-regular.woff') format('woff');
    }

    @font-face {
        font-display: block;
        font-family: 'DSIndigo';
        font-style: normal;
        font-weight: 500;
        src: url('https://www.docusign.com/assets/fonts/dsindigo-medium.woff2') format('woff2'), url('https://www.docusign.com/assets/fonts/dsindigo-medium.woff') format('woff');
    }

    @font-face {
        font-display: block;
        font-family: 'DSIndigo';
        font-style: normal;
        font-weight: 600;
        src: url('https://www.docusign.com/assets/fonts/dsindigo-semibold.woff2') format('woff2'), url('https://www.docusign.com/assets/fonts/dsindigo-semibold.woff') format('woff');
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ09DdVWYVP8c9MMEL.woff2) format('woff2');
        unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ09ndVWYVP8c9MMEL.woff2) format('woff2');
        unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ09HdVWYVP8c9MMEL.woff2) format('woff2');
        unicode-range: U+1F00-1FFF;
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ097dVWYVP8c9MMEL.woff2) format('woff2');
        unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ09LdVWYVP8c9MMEL.woff2) format('woff2');
        unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ09PdVWYVP8c9MMEL.woff2) format('woff2');
        unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    @font-face {
        font-family: 'Noto Sans Mono';
        font-style: normal;
        font-weight: 400;
        font-stretch: 100%;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/notosansmono/v30/BngrUXNETWXI6LwhGYvaxZikqZqK6fBq6kPvUce2oAZcdthSBUsYck4-_FNJ093dVWYVP8c9MA.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }

    * {
        box-sizing: border-box;
        font-family: DSIndigo, Helvetica, Arial, sans-serif;
    }

    p {
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
    }

    sup {
        font-size: 0.8em;
        line-height: 1;
    }

    html,
    body {
        background: #ffffff;
        color: #130032;
        font-weight: 400;
        margin: 0;
        scroll-padding-top: 8rem;
    }
</style>
<style>
    body {
        font-family: "DS Indigo", DSIndigo, "Neue Haas Grotesk", NeueHaasGrotesk, Helvetica, Arial, sans-serif;
        margin: 0;
        overflow-x: hidden;
    }

    h1 {
        color: white;
        font-size: 2.4rem;
        margin-bottom: 10px;
    }

    h2 {
        padding-bottom: 10px;
        color: white;
    }

    h2.table-header {
        padding: 5px;
        color: #6c757d;
    }

    .big-container {
        max-width: 110%;
        margin: -40px;
    }

    #ctl00_MainContent_ContentHeader {
        display: none;
    }
    /* Term Summary Table */
    #comparisonTableContainer {
        max-width: 100%;
        overflow-x: auto;
        white-space: normal;
        padding: 10px;
        box-sizing: border-box;
        margin: 10px;
    }

    /* Clause Content Table */
    #clauseContentContainer {
        max-width: 100%;
        padding: 10px;
        box-sizing: border-box;
        margin: 10px;
    }

    #comparisonTableContainer table,
    #clauseContentContainer table {
        width: 100%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        /* Add a light shadow to the bottom */
        position: relative;
        font-size: 16px;
    }

    #comparisonTableContainer th,
    #comparisonTableContainer td,
    #clauseContentContainer th,
    #clauseContentContainer td {
        border: 1px solid #dddddd;
        text-align: center;
        padding: 8px;
    }

    #comparisonTableContainer th:first-child,
    #comparisonTableContainer td:first-child,
    #clauseContentContainer th:first-child,
    #clauseContentContainer td:first-child {
        text-align: left;
        position: sticky;
        width: 200px;
    }

    #comparisonTableContainer th,
    #clauseContentContainer th {
        background-color: #f4f4f4;
        font-family: "DS Indigo", DSIndigo, Helvetica, Arial, sans-serif;
        font-size: 12px;
        font-weight: 600;
        line-height: 1.5;
        letter-spacing: 0.8px;
        -webkit-box-align: center;
        align-items: center;
        background: 0px 0px;
        border: none;
        border-radius: 0px;
        color: inherit;
        cursor: pointer;
        margin: 0px;
        padding: 8px;
        text-transform: inherit;
        white-space: nowrap;
    }

    /* #comparisonTableContainer tr:nth-child(even),
        #clauseContentContainer tr:nth-child(even) {
            background-color: #f9f9f9;
        } */

    #comparisonTableContainer tr:hover,
    #clauseContentContainer tr:hover {
        background-color: #f1f1f1;
    }

    #comparisonTableContainer th,
    #comparisonTableContainer td,
    #clauseContentContainer th,
    #clauseContentContainer td {
        border-left: 0;
        border-right: 0;
    }

    #comparisonTableContainer th,
    #clauseContentContainer th {
        background-color: rgb(246, 242, 255);
    }

    /* Highlight the rightmost column */
    #comparisonTableContainer td:last-child,
    #clauseContentContainer td:last-child {
        border-left: 1px solid rgb(224, 212, 255);
    }

    #comparisonTableContainer th:last-child,
    #clauseContentContainer th:last-child {
        background-color: rgb(224, 212, 255);
        /* Darker orange for header */
        color: black;
        /* White text for header */
        border: 3px solid rgb(224, 212, 255);
    }

    /* Basic styling for the contract display */
    .contract-container {
        font-family: Arial, sans-serif;
        margin: 0px;
    }

    .contract-header {
        background-color: #e0e0e0;
        color: #6c757d;
        padding: 10px;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: larger;
        max-width: 800px;

    }

    .contract-header .contract-name {
        color: black;
    }

    .contract-children,
    .child-record {
        padding: 10px;
        display: none;
    }

    .contract-children.expanded {
        display: block;
        background-color: white;
        color: black;
        border-radius: 3px;
        margin-top: 5px;
        max-width: 800px;
    }

    .child-record {
        border-top: 1px solid #ddd;
    }

    .record-type {
        font-size: 0.9em;
        color: #6c757d;
    }

    .child-record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .child-record-header:hover {
        background-color: #f0f0f0;
    }

    .collapse-icon {
        transform: rotate(90deg);
        transition: transform 0.3s;
    }

    .expanded .collapse-icon {
        transform: rotate(0deg);
    }

    .child-record-content {
        display: none;
    }

    .expanded .child-record-content {
        display: block;
    }

    /* Container to hold the two divs side by side */
    .row-container {
        display: flex;
        /* Use Flexbox to arrange children side by side */
        gap: 0px;
        /* Gap between the two divs */
        padding: 20px 10px;
        /* Padding around the container */
        box-sizing: border-box;
        /* Include padding in the total width */
        box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.1);
        /* Add a light shadow to the bottom */
        background-color: rgb(33, 78, 159);
        /* Black background color */
        color: white;
        /* White text color */
        max-width: 100%;
        /* Set maximum width to 100% of screen size */
    }

    /* Contract Display takes up 2/3 of the row */
    #contractDisplay {
        flex: 2;
        /* Takes up 2/3 of the available space */
        border-left: 3px solid white;
        padding: 15px;
        /* Padding inside the div */
        border-radius: 0px;
        /* Rounded corners */
    }

    /* Contact Details takes up 1/3 of the row */
    #contractDetails {
        flex: 1;
        max-width: 400px;
        /* Takes up 1/3 of the available space */
        padding: 15px;
        /* Padding inside the div */
        border-radius: 0px;
        /* Rounded corners */
        font-size: large;
    }

    /* Add styles for the header row and drop-down menu */
    .header-row {
        padding: 10px 20px;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        float: left;
        width: 100%;
        margin-bottom: 20px;
    }

    .subheader-row {
        text-align: right;
        padding: 10px;
        border-top: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        margin-right: 10px;
    }

    .dropdown {
        position: relative;
        display: inline-block;
        background-color: #f8f9fa;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f8f9fa;
        min-width: 260px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
    }

    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: #e0e0e0;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .dropdown .dropbtn {
        border-style: none;
        border-color: inherit;
        border-width: 0px;
        background-color: #f8f9fa;
        font-size: 1.1em;
        color: black;
    }
</style>


<div class="big-container">
    <!-- Main container to hold both contract display and contact details -->
    <div class="row-container">
        <!-- Contact Details (1/3 width) -->
        <div id="contractDetails">
            <!-- Contact details content will be added here -->
        </div>
        <!-- Contract Display (2/3 width) -->
        <div id="contractDisplay" class="contract-container">
            <!-- Contract display content will be dynamically added here -->
        </div>
    </div>
    <!-- Header row with drop-down menu -->
    <div class="header-row">
        <div class="dropdown">
            <button class="dropbtn" disabled>Actions <span style="float: right"
                    data-qa="header-ActionsMenuName-tab-button-end" class="css-1d11tbi"><span class="css-hg1vx5"><span
                            aria-hidden="true" class="SVGInline"><svg class="SVGInline-svg" fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false">
                                <path d="m22 8.34-9.41 9.41a.82.82 0 0 1-1.18 0L2 8.34 3.34 7 12 15.66 20.66 7z"></path>
                            </svg></span></span></span></button>
            <div class="dropdown-content">
                <a href="#" id="generateTermSummary">Generate Prevailing Term Summary</a>
                <a href="#" id="generateAmendment">Generate Amendment</a>
                <a href="#" onclick="document.getElementById('generateButton').click();">Refresh Clause Library</a>
                <a href="#" onclick="document.getElementById('generateButton').click();">Sync Data to Ariba</a>
            </div>
        </div>
    </div>
    <div class="subheader-row">
        <label for="toggleContractActive">Show Inactive Contracts</label>
        <input type="checkbox" id="toggleContractActive" onchange="toggleContracts(relatedDocuments)">
        <!-- <label for="toggleParentPrevailing">Show Only Parent and Prevailing</label>
        <input type="checkbox" id="toggleParentPrevailing" onchange="toggleContractComparison(relatedDocuments)"> -->
        <label for="filterDropdown">Filter by Category:</label>
        <select id="filterDropdown" onchange="filterDatapoints(this.value)">
            <option value="">All</option>
            <option value="General">General</option>
            <option value="Legal">Legal</option>
            <option value="Finance">Finance</option>
        </select>
    </div>
    <div id="comparisonTableContainer"></div>
    <div id="clauseContentContainer"></div>
</div>
<script>
    function loadCss(file) {
        var link = document.createElement('link');
        link.href = file;
        link.type = 'text/css';
        link.rel = 'stylesheet';
        document.querySelector('head').appendChild(link);
    }

    function extractURLParameter(url, name) {
        return (RegExp(name + '=' + '(.+?)(&|$)').exec(url) || [, null])[1];
    };

    var url = document.referrer;
    var aId = decodeURIComponent(extractURLParameter(url, 'aid').replace(/\+/g, " "));
    var docId = decodeURIComponent(extractURLParameter(url, 'Id').replace(/\+/g, " "));
    var env = document.location.href.split("https://")[1].split('.')[0];

    loadCss('https://ux.springcm.com/ux/releases/0.10.5/css/SpringCM.UX.min.css');
    loadCss('https://ux.springcm.com/ux/releases/0.10.5/css/Atlas.Forms.min.css');
    loadCss(`https://${env}.springcm.com/atlas/ThemeCss?aid=${aId}`);
</script>

<script>
    var _scmComponentLibraryPath = 'https://ux.springcm.com/ux/releases/0.10.5/images';
</script>
<script src='https://ux.springcm.com/ux/releases/0.10.5/js/SpringCM.UX.min.js'></script>
<script>
    jqueryUX = jQuery.noConflict(true);
</script>

<script type="text/javascript">
    // Replace with your DocuSign Account API ID
    // Find it under eSign->Settings->Apps and Keys
    var docuSignaId = "9bb5a5f6-9bd2-4956-bacc-0bdc19387c91";
    var searchResults = null;

    var xmlContent = '<Attributes>';

    // Declare the attributesArray and contractNumber globally
    var relatedDocuments = [];  // Assume you populate this with your data
    var contractNumber = '';   // Your contract number

    // This variable will keep track of the toggle state
    var showInactiveContracts = "False";

    $("[ScmFormControl]").bind(Atlas.Forms.SCM_FORM_AFTER_DATA_LOAD, function (e) {

        // Hide top button group and bottom buttons
        $('div.buttonGroup:first').hide();
        $('div.buttonDiv').hide();
        $('div.buttonDiv:last input')[0].value = 'Return to Document';

        if (docId === '') {
            $('div#spinnerOverlay').hide();
            $('div#errorMissingDocID').show();
            $('div.buttonDiv:last').show();
        } else {
            getDocumentAttributes(docId)
                .then(parentAttributes => {
                    const contractNumber = parentAttributes.ContractNumber;

                    // Fetch related documents based on contract number and return the result
                    return fetchRelatedDocuments(contractNumber)
                        .then(relatedDocuments => {
                            return { parentAttributes, relatedDocuments, contractNumber }; // Pass both parentAttributes and relatedDocuments forward
                        });
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    // If there are child document IDs, fetch their attributes
                    if (relatedDocuments.length > 0) {
                        return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                    } else {
                        return { relatedDocuments: [] };
                    }
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    displayContracts(relatedDocuments);

                    var contractDetails = displayContractDetails(relatedDocuments, contractNumber);
                    document.getElementById('contractDetails').innerHTML = contractDetails;

                    return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    var tableHtml = generateComparisonTable(relatedDocuments, contractNumber);
                    document.getElementById('comparisonTableContainer').innerHTML = tableHtml;

                    return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    var clauseLanguage = fetchAndFilterClauseContent(searchResults);

                    return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                })
                .catch(error => {
                    console.log("Error:", error);
                    $('div#spinnerOverlay').hide();
                    if (error === 'No attribute data') {
                        $('div#errorNoAttributes').show();
                    } else {
                        $('div#errorAPI').show();
                    }
                });

        }
    });

    var clauseContents = []; // Global variable to store clause contents

    function filterDatapoints(category) {
        // Get all rows in the comparison table
        var comparisonRows = document.querySelectorAll('#comparisonTableContainer tr');

        // Function to filter rows based on category
        function filterRows(rows) {
            rows.forEach(row => {
                var dataCategory = row.getAttribute('data-category');

                // If no category is selected or row doesn't have a data-category attribute, show all rows
                if (category === "" || !dataCategory) {
                    row.style.display = "";
                } else {
                    // Split the data-category attribute into an array of categories
                    var categoriesArray = dataCategory.split(" ");

                    // Check if the selected category is in the array of categories
                    if (categoriesArray.includes(category)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            });
        }

        // Apply filter to the rows
        filterRows(comparisonRows);
    }


    // Function to handle the toggle switch
    function toggleContractComparison(relatedDocuments) {

        console.log('Toggle switch clicked');
        console.log('relatedDocuments:', relatedDocuments);
        // Toggle the boolean value
        show = document.getElementById('toggleContractActive').checked ? "True" : "False";

        // Re-generate the table with the current toggle state and attributesArray
        document.getElementById('comparisonTableContainer').innerHTML = generateComparisonTable(relatedDocuments, contractNumber);
    }

    // Function to handle the toggle switch
    function toggleContracts(relatedDocuments) {

        console.log('Toggle switch clicked');
        console.log('relatedDocuments:', relatedDocuments);
        // Toggle the boolean value
        showInactiveContracts = document.getElementById('toggleContractActive').checked ? "True" : "False";

        // Re-generate the table with the current toggle state and attributesArray
        document.getElementById('comparisonTableContainer').innerHTML = generateComparisonTable(relatedDocuments, contractNumber);
    }

    /**
     * Fetches and filters clause content based on the provided attributes array.
     * 
     * @param {Array} attributesArray - The array of attributes.
     * @returns {Promise} - A promise that resolves to the clause contents.
     * @throws {Error} - If there is an error fetching and filtering clause content.
     */
    function fetchAndFilterClauseContent(attributesArray) {
        attributesArray = attributesArray.Result.Items;
        var filteredAttributes = attributesArray.filter(attributes => attributes.Extension === 'sxterm');
        var promises = filteredAttributes.map(attributes => getClauseContent(attributes.Uid));

        return Promise.all(promises)
            .then(clauseContentsArray => {
                clauseContentsArray.forEach((clauseContent, index) => {
                    clauseContents[filteredAttributes[index].DocumentID] = clauseContent;
                });
                displayClauseContent(clauseContents);
                return clauseContents;
            })
            .catch(error => {
                console.error('Error fetching and filtering clause content:', error);
                throw error;
            });
    }

    function displayClauseContent(clauseContents) {

        // Sort by CommonName (ascending) and then by EffectiveDate (descending)
        clauseContents.sort((a, b) => {
            const commonNameA = a.Name.split('-')[0].trim();
            const commonNameB = b.Name.split('-')[0].trim();
            const originA = a.Name.split('-')[1]?.trim() || '';
            const originB = b.Name.split('-')[1]?.trim() || '';
            const dateA = a.EffectiveDate ? new Date(a.EffectiveDate.slice(0, 4), a.EffectiveDate.slice(4, 6) - 1, a.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');
            const dateB = b.EffectiveDate ? new Date(b.EffectiveDate.slice(0, 4), b.EffectiveDate.slice(4, 6) - 1, b.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');

            if (commonNameA < commonNameB) return -1;
            if (commonNameA > commonNameB) return 1;
            if (dateA > dateB) return -1;
            if (dateA < dateB) return 1;
            return 0;
        });

        var tableHtml = '<h2 class="table-header">Clause Content</h2>';
        tableHtml += '<table>';
        tableHtml += '<tr><th>Name</th><th>Origin</th><th>Content</th><th>Date</th></tr>';

        clauseContents.forEach((clause, index) => {
            const commonName = clause.Name.split('-')[0].trim();
            const origin = clause.Name.split('-').slice(1).join('-').trim();

            tableHtml += '<tr';
            if (index === 0) {
                tableHtml += ` style="border-bottom: 3px double black;"`;
            }
            tableHtml += '>';
            if (index === 0 || commonName !== clauseContents[index - 1].Name.split('-')[0].trim()) {
                tableHtml += `<td rowspan="${getRowCount(clauseContents, index)}">${commonName}</td>`;
            }
            tableHtml += `<td style="text-align: left;">${origin}</td>`;
            tableHtml += `<td style="text-align: left;">${clause.Content}</td>`;
            tableHtml += `<td>${formatDate(clause.EffectiveDate)}</td>`;
            tableHtml += '</tr>';
        });

        tableHtml += '</table>';
        document.getElementById('clauseContentContainer').innerHTML = tableHtml;
        return tableHtml;
    }

    /**
     * Calculates the number of rows needed for a common name in the clauseContents array.
     * 
     * @param {Array} clauseContents - The array of clause contents.
     * @param {number} currentIndex - The current index in the clauseContents array.
     * @returns {number} The number of rows needed for the common name.
     */
    function getRowCount(clauseContents, currentIndex) {
        let rowCount = 1;
        var currentCommonName = clauseContents[currentIndex].Name.split('-')[0].trim();
        var nextIndex = currentIndex + 1;

        while (nextIndex < clauseContents.length) {
            const nextCommonName = clauseContents[nextIndex].Name.split('-')[0].trim();
            if (nextCommonName === currentCommonName) {
                rowCount++;
                nextIndex++;
            } else {
                break;
            }
        }

        return rowCount;
    }

    /**
     * Retrieves the content of a clause from a SpringCM document.
     * 
     * @returns {Promise} A promise that resolves with the JSON data containing the clause content.
     */
    function getClauseContent(documentID) {
        let downloadURL = "https://apidownloaduatna11.springcm.com/v2/" + docuSignaId + "/documents/" + documentID;
        return new Promise(function (resolve, reject) {
            console.log('Fetching document content from URL:', downloadURL);
            SpringCM.API.get(downloadURL, function (_data) {
                try {
                    const jsonData = JSON.parse(_data);

                    getDocumentAttributes(documentID)
                        .then(documentAttributes => {
                            clauseContents.push({
                                "Name": jsonData['0'].Name,
                                "Content": jsonData['0'].Content,
                                "Notes": jsonData['0'].Notes,
                                "Uid": jsonData['0'].Uid,
                                "DocId": documentAttributes.ParentDocID,
                                "EffectiveDate": documentAttributes.EffectiveDate
                            });
                            resolve(jsonData);
                        })
                        .catch(error => {
                            console.error('Error getting document attributes:', error);
                            reject(error);
                        });
                } catch (error) {
                    console.error('Error parsing JSON data:', error);
                    reject(error);
                }
            });
        });
    }

    function getDocumentAttributes(docId) {
        return new Promise(function (resolve, reject) {
            SpringCM.API.get(`/v2/${docuSignaId}/documents/${docId}?expand=AttributeGroups`, function (data) {
                if (data.responseText) {
                    console.error('Error in response:', data.responseText);
                    reject(data.responseText);
                    return;
                }

                try {
                    var parentFolderHref = data.ParentFolder.Href;
                    var parentFolderId = parentFolderHref.split('/folders/')[1];
                    var attributes = data.AttributeGroups || {};
                    var hasCLMDocumentDetails = attributes['CLM Agreement Details'] !== undefined;

                    var documentAttributes;
                    if (!hasCLMDocumentDetails) {
                        documentAttributes = {
                            "ParentDocID": docId,
                            "ParentFolderID": parentFolderId,
                            "DocumentName": attributes['CLM Document Details']?.['Name']?.Value || '',
                            "EffectiveDate": attributes['CLM Document Details']?.['Effective Date']?.Value || '',
                        };
                    } else {
                        documentAttributes = {
                            "ParentDocID": docId,
                            "ParentFolderID": parentFolderId,
                            "DocumentName": attributes['CLM Agreement Details']?.['Name']?.Value || '',
                            "Type": attributes['CLM Agreement Details']?.['Type']?.Value || '',
                            "EffectiveDate": attributes['CLM Agreement Details']?.['Effective Date']?.Value || '',
                            "ExpirationDate": attributes['CLM Agreement Details']?.['Expiration Date']?.Value || '',
                            "AgreementID": attributes['CLM Agreement Details']?.['Agreement ID']?.Value || '',
                            "PartyID": attributes['CLM Agreement Details']?.['Party ID']?.Value || '',
                            "PartyName": attributes['CLM Agreement Details']?.['Party Name']?.Value || '',
                            "PaymentDuration": attributes['CLM Agreement Details']?.['Payment Duration']?.Value || '',
                            "PaymentDurationUnit": attributes['CLM Agreement Details']?.['Payment Duration Unit']?.Value || '',
                            "PaymentLateFees": attributes['CLM Agreement Details']?.['Payment Late Fees']?.Value || '',
                            "PaymentTerms": attributes['CLM Agreement Details']?.['Payment Terms']?.Value || '',
                            "RenewalNoticePeriod": attributes['CLM Agreement Details']?.['Renewal Notice Period']?.Value || '',
                            "RenewalNoticePeriodUnit": attributes['CLM Agreement Details']?.['Renewal Notice Period Unit']?.Value || '',
                            "RenewalTerm": attributes['CLM Agreement Details']?.['Renewal Term']?.Value || '',
                            "RenewalTermUnit": attributes['CLM Agreement Details']?.['Renewal Term Unit']?.Value || '',
                            "Requestor": attributes['CLM Agreement Details']?.['Requestor']?.Value || '',
                            "Signed": attributes['CLM Agreement Details']?.['Signed']?.Value || '',
                            "TerminationCause": attributes['CLM Agreement Details']?.['Termination Cause']?.Value || '',
                            "TerminationConvenience": attributes['CLM Agreement Details']?.['Termination Convenience']?.Value || '',
                            "TerminationNotice": attributes['CLM Agreement Details']?.['Termination Notice']?.Value || '',
                            "TerminationNoticeDate": attributes['CLM Agreement Details']?.['Termination Notice Date']?.Value || '',
                            "TerminationNoticeUnit": attributes['CLM Agreement Details']?.['Termination Notice Unit']?.Value || '',
                            "LimitationLiability": attributes['CLM Agreement Details']?.['Limitation of Liability']?.Value || '',
                            "Value": attributes['CLM Agreement Details']?.['Value']?.Value || '',
                            "ContractNumber": attributes['Contract Record']?.['Contract Number']?.Value || '',
                            "ContractIsActive": attributes['Contract Record']?.['Is Active?']?.Value || '',
                            "ContractIsParent": attributes['Contract Record']?.['Is Parent?']?.Value || '',
                        };
                    }

                    resolve(documentAttributes);
                } catch (error) {
                    console.error('Error processing attributes data:', error);
                    reject(error);
                }
            });
        });
    }

    function fetchRelatedDocuments(contractNumber) {
        return getAllDocumentIds(contractNumber)
            .then(relatedDocuments => {
                // Do any additional processing if needed
                return relatedDocuments; // Return the list of related documents
            })
            .catch(error => {
                console.error('Error fetching related documents:', error);
                throw error; // Propagate the error for handling in the outer promise chain
            });
    }

    function extractAndSortAgreementDetails(data) {
        const result = [];

        // Iterate through each item in the Items array
        data.Result.Items.forEach(item => {
            const clmDetails = item.AttributeGroups["CLM Agreement Details"];
            const contractRecordDetails = item.AttributeGroups["Contract Record"];

            console.log('Contract Record Details:', contractRecordDetails);

            // Check if CLM Agreement Details exists to avoid errors
            if (clmDetails) {
                // Extract specific details from CLM Agreement Details
                const details = {
                    DocumentID: item["Uid"], // Add DocumentID
                    Name: clmDetails.Name?.Value || 'N/A',
                    PartyName: clmDetails["Party Name"]?.Value || 'N/A',
                    PartyID: clmDetails["Party ID"]?.Value || 'N/A',
                    Type: clmDetails.Type?.Value || 'N/A',
                    EffectiveDate: clmDetails["Effective Date"]?.Value || 'N/A',
                    ExpirationDate: clmDetails["Expiration Date"]?.Value || 'N/A',
                    Value: clmDetails.Value?.Value || 'N/A',
                    Requestor: clmDetails.Requestor?.Value || 'N/A',
                    PaymentTerms: clmDetails["Payment Terms"]?.Value || 'N/A',
                    PaymentDuration: clmDetails["Payment Duration"]?.Value || 'N/A',
                    PaymentDurationUnit: clmDetails["Payment Duration Unit"]?.Value || 'N/A',
                    PaymentLateFees: clmDetails["Payment Late Fees"]?.Value || 'N/A',
                    LimitationLiability: clmDetails["Limitation of Liability"]?.Value || 'N/A',
                    Assignable: clmDetails.Assignable?.Value || 'N/A',
                    Indemnity: clmDetails.Indemnity?.Value || 'N/A',
                    TerminationCause: clmDetails["Termination Cause"]?.Value || 'N/A',
                    TerminationConvenience: clmDetails["Termination Convenience"]?.Value || 'N/A',
                    ContractIsParent: contractRecordDetails["is Parent?"]?.Value || 'N/A',
                    ContractIsActive: contractRecordDetails["is Active?"]?.Value || 'N/A',
                };

                // Add extracted details to the result array
                result.push(details);
            }
        });

        // Sort by EffectiveDate (oldest to newest) - original format is 20230224000000
        result.sort((a, b) => {
            const dateA = a.EffectiveDate ? new Date(a.EffectiveDate.slice(0, 4), a.EffectiveDate.slice(4, 6) - 1, a.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');
            const dateB = b.EffectiveDate ? new Date(b.EffectiveDate.slice(0, 4), b.EffectiveDate.slice(4, 6) - 1, b.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');

            if (isNaN(dateA)) return 1; // Treat invalid dateA as greater
            if (isNaN(dateB)) return -1; // Treat invalid dateB as greater

            return dateA - dateB;
        });

        return result;
    }

    function getAllDocumentIds(contractNumber) {
        // Return a single Promise
        return new Promise(function (resolve, reject) {
            // Define the payload with the contract number
            const payload = {
                "AttributeFields": [
                    {
                        "Group": "Contract Record",
                        "Field": "Contract Number",
                        "Value": contractNumber // Use the input contract number
                    }
                ]
            };

            // Send the POST request with the payload
            SpringCM.API.post(`/v2/${docuSignaId}/documentsearchtasks/?expand=AttributeGroups`, payload, (data) => {
                if (data.responseText) {
                    reject(data.responseText); // Reject the promise on error
                } else {
                    searchResults = data;
                    const refinedData = extractAndSortAgreementDetails(data);
                    resolve(refinedData); // Resolve the promise on success
                }
            });
        });
    }

    function generateComparisonTable(attributesArray, contractNumber) {
        console.log('Generating Comparison Table with attributesArray:', attributesArray);
        var tableHtml = `<h2 class="table-header">Term Summary Table</h2>`;

        // Remove any rows where parent.Name contains "sxterm"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("sxterm"));

        // Remove any rows where parent.Name contains "Prevailing"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("Prevailing"));

        // Filter agreements based on the toggle state
        if (showInactiveContracts === "False") {
            attributesArray = attributesArray.filter(parent => parent.ContractIsActive === "True");
        }

        // Check if the array has at least one item
        if (!attributesArray || attributesArray.length === 0) {
            return '<p>No data available.</p>';
        }

        // The parent attributes are the first item in the array
        var parentAttributes = attributesArray[0];
        var childAttributesArray = attributesArray.slice(1); // The rest are child attributes

        tableHtml += '<table>';
        tableHtml += '<tr><th>Datapoint</th><th>Parent</th>';

        // Add column headers for each child document
        childAttributesArray.forEach((_, index) => {
            tableHtml += `<th>Child ${index + 1}</th>`;
        });
        tableHtml += '<th>Prevailing Terms</th></tr>';

        // Define a mapping between keys and categories
        const categoryMapping = {
            'Name': ['General', 'Legal', 'Finance'],
            'EffectiveDate': ['General', 'Legal', 'Finance'],
            'ExpirationDate': ['General', 'Legal', 'Finance'],
            'Value': ['Finance'],
            'AgreementType': ['Legal'],
            'Requestor': ['General'],
            'PaymentTerms': ['Finance'],
            'PaymentDuration': ['Finance'],
            'PaymentDurationUnit': ['Finance'],
            'PaymentLateFees': ['Finance'],
            'LimitationOfLiability': ['Legal'],
            'Assignable': ['Legal'],
            'Indemnity': ['Legal'],
            'TerminationCause': ['Legal'],
            'TerminationConvenience': ['Legal'],
            'ContractIsParent': ['General'],
            'ContractIsActive': ['General'],
            // Add other mappings as needed
        };

        // Parse parent attributes
        var parsedParentAttributes = parseAttributes(parentAttributes);

        // Get all unique keys from parent attributes and all child attributes
        var allKeys = new Set(Object.keys(parsedParentAttributes));
        childAttributesArray.forEach(childAttributes => {
            var parsedChildAttributes = parseAttributes(childAttributes);
            // Merge child attributes keys
            allKeys = new Set([...allKeys, ...Object.keys(parsedChildAttributes)]);
        });

        // List of keys to skip
        const keysToSkip = ['DocumentID', 'PartyName', 'ParentDocID', 'ParentFolderID', 'AgreementID', 'PartyID', 'ChildAgreementIds', 'ParentAgreementId', 'Signed'];

        // Generate table rows for parent and each child
        allKeys.forEach(key => {
            // Skip if the key is in the keysToSkip array
            if (keysToSkip.includes(key)) {
                return;
            }

            // Get the parent value and replace 'N/A' with an empty string
            var parentValue = parsedParentAttributes[key] || '';
            parentValue = parentValue === 'N/A' ? '' : parentValue;

            var childValues = [];
            var prevailingTerm = '';

            // Initialize sum for 'Value' key
            var sum = 0;

            // Convert to USD Currency if the key is 'Value'
            if (key === 'Value') {
                // Try to parse parentValue as a number
                sum += parseFloat(parentValue) || 0;
                parentValue = formatCurrency(parentValue);
            }

            // Format EffectiveDate and ExpirationDate
            if (key === 'EffectiveDate' || key === 'ExpirationDate') {
                parentValue = formatDate(parentValue);
            }

            childAttributesArray.forEach(childAttributes => {
                var childValue = (childAttributes[key] || '').toString();
                // Replace 'N/A' with an empty string
                childValue = childValue === 'N/A' ? '' : childValue;

                // Convert to USD Currency if the key is 'Value'
                if (key === 'Value') {
                    // Try to parse childValue as a number
                    sum += parseFloat(childValue) || 0;
                    childValue = formatCurrency(childValue);
                }

                // Format EffectiveDate and ExpirationDate
                if (key === 'EffectiveDate' || key === 'ExpirationDate') {
                    childValue = formatDate(childValue);
                }

                childValues.push(childValue);
            });

            // Determine prevailingTerm based on the sum of 'Value'
            if (key === 'Value') {
                prevailingTerm = formatCurrency(sum);
            } else {
                prevailingTerm = parentValue;

                // Update prevailingTerm based on child values
                for (var i = childValues.length - 1; i >= 0; i--) {
                    if (childValues[i]) {
                        prevailingTerm = childValues[i];
                        break;
                    }
                }
            }

            // Replace 'N/A' with empty string for prevailingTerm
            prevailingTerm = prevailingTerm === 'N/A' ? '' : prevailingTerm;

            if (key === 'Name' || key === 'Type') {
                prevailingTerm = '';
            }

            // Get the category for the current key
            var categories = categoryMapping[key] || [];
            var dataCategoryAttr = categories.length > 0 ? `data-category="${categories.join(' ')}"` : '';

            // Wrap prevailing term in <strong> tags
            var parentValueHtml = parentValue === prevailingTerm ? `<strong>${parentValue}</strong>` : parentValue;
            var childValuesHtml = childValues.map(value => value === prevailingTerm ? `<strong>${value}</strong>` : value);
            var prevailingTermHtml = `<strong>${prevailingTerm}</strong>`;

            // Generate the row with the data-category attribute
            tableHtml += `<tr ${dataCategoryAttr}><td>${key}</td><td>${parentValueHtml}</td>${childValuesHtml.map(value => `<td>${value}</td>`).join('')}<td>${prevailingTermHtml}</td></tr>`;

            // Add to XML content if there's content
            if (prevailingTerm) {
                xmlContent += `  <${key}>${prevailingTerm}</${key}>`;
            }
        });

        // Close the XML content
        xmlContent += `<ParentDocID>${parsedParentAttributes['ParentDocID']}</ParentDocID>`;
        xmlContent += `<ParentFolderID>${parsedParentAttributes['ParentFolderID']}</ParentFolderID>`;
        xmlContent += `<PartyID>${parsedParentAttributes['PartyID']}</PartyID>`;
        xmlContent += '</Attributes>';

        tableHtml += '</table>';
        return tableHtml;
    }


    // Function to display contracts dynamically in a tree view
    function displayContracts(attributesArray) {
        const container = document.getElementById('contractDisplay');

        // remove any rows were parent.Name contains "sxterm"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("sxterm"));

        // Remove any rows where parent.Name contains "Prevailing"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("Prevailing"));

        console.log('Attributes Array:', attributesArray);

        // update global relatedDocuments variable
        relatedDocuments = attributesArray;

        // Clear existing content before adding new content
        container.innerHTML = '<h2>Contract Hierarchy</h2>';
        var parent = attributesArray[0];
        var children = attributesArray.slice(1); // The rest are child attributes

        // Create the parent contract header
        const parentDiv = document.createElement('div');
        parentDiv.classList.add('contract-header');
        parentDiv.innerHTML = `
                    <div>
                        <strong class="contract-name">${parent.Name}</strong> - ${parent.Type} - ${formatDate(parent.EffectiveDate)} | <a href='https://uatna11.springcm.com/atlas/Documents/View?aid=19447&Id=${parent.DocumentID}' target='_blank'>Link</a>
                    </div>
                    <div class="contract-record-indicator">
                        ${children.length} child records
                    </div>
                `;
        container.appendChild(parentDiv);

        // Create the children container
        const childrenContainer = document.createElement('div');
        childrenContainer.classList.add('contract-children');
        const iconGraphic = `<img src="https://cdn3.iconfinder.com/data/icons/seo-search-engine-optimization/64/seo_web_Search_Engine_Optimization_hierarchy_map_navigation_sitemap_orgnization_tree_site-512.png" width=16 height=16>`;
        children.forEach(child => {
            const childDiv = document.createElement('div');
            childDiv.innerHTML = `
                <strong>${child.Name}</strong> - ${child.Type} - ${formatDate(child.EffectiveDate)} - 
                <a href='https://uatna11.springcm.com/atlas/Documents/View?aid=19447&Id=${child.DocumentID}' target='_blank'>Link</a> | 
                ${child.Requestor} | 
                ${child.ContractIsParent === 'True' ? `<a href='https://uatna11.springcm.com/atlas/Documents/View?aid=19447&Id=${child.DocumentID}' target='_blank'>${iconGraphic}</a>` : ''}
                `;
            childrenContainer.appendChild(childDiv);
        });

        container.appendChild(childrenContainer);

        // Add event listener to toggle .expanded class
        parentDiv.addEventListener('click', () => {
            childrenContainer.classList.toggle('expanded');
        });
    }

    // Function to display high-level contract details that fills in contractDetails
    function displayContractDetails(parent, contractNumber) {
        // Clear existing content before adding new content
        var contractDetailsHtml = `<h1> ${contractNumber}</h1> <strong>Party Name:</strong> ${parent[0].PartyName} <br/> <strong>Account Owner:</strong> ${parent[0].Requestor}`;

        return contractDetailsHtml;
    }

    // Function to use XML content
    function callWorkflowApi(event, endpoint) {

        // Prevent the default form submission behavior
        if (event) {
            event.preventDefault();
        }

        // Ensure xmlContent is a string
        if (typeof xmlContent !== 'string') {
            throw new Error('xmlContent is not a string');
        }

        // Escape and send XML content
        var escapedXmlContent = xmlContent.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        var body = JSON.stringify({
            Name: endpoint,
            Params: escapedXmlContent
        });

        return new Promise(function (resolve, reject) {
            SpringCM.API.post(`/v2/${docuSignaId}/workflows`, body, function (response) {
                // Log the response to debug
                if (response && response.status === 200) {
                    resolve(response);
                }
                else if (response) {
                    alert(endpoint, ' initiated.')
                }
                else {
                    // Log the response in case of error
                    console.error('Error Response:', response);
                    reject(new Error('Failed to post XML content'));
                }
            }).catch(function (error) {
                // Log errors if any
                console.error('Request Error:', error);
                reject(error);
            });
        });

    }


    function parseAttributes(attributes) {
        var parsedAttributes = {};
        for (var key in attributes) {
            if (attributes.hasOwnProperty(key)) {
                // Assuming attributes[key] is a primitive value
                parsedAttributes[key] = attributes[key] || '';
            }
        }
        return parsedAttributes;
    }

    function formatCurrency(value) {
        if (isNaN(value)) return '';
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        // Extract year, month, and day from the dateString
        var year = dateString.substring(0, 4);
        var month = dateString.substring(4, 6);
        var day = dateString.substring(6, 8);

        // Format date as MM/DD/YYYY
        return `${month}/${day}/${year}`;
    }

    var workflowNamePrevailingTermSummary = 'Prevailing Term Summary';
    var workflowNameGenerateAmendment = 'Prevailing Term Amendment';

    document.getElementById('generateTermSummary').addEventListener('click', function (event) {
        callWorkflowApi(event, workflowNamePrevailingTermSummary);
    });

    document.getElementById('generateAmendment').addEventListener('click', function (event) {
        callWorkflowApi(event, workflowNameGenerateAmendment);
    });
</script>