<link rel="stylesheet" href="https://storage.googleapis.com/clm_workshop_assets/pt_style.css">

<div class="big-container">
    <!-- Main container to hold both contract display and contact details -->
    <div class="row-container">
        <!-- Contact Details (1/3 width) -->
        <div id="contractDetails">
            <!-- Contact details content will be added here -->
        </div>
        <!-- Contract Display (2/3 width) -->
        <div id="contractDisplay" class="contract-container">
            <!-- Contract display content will be dynamically added here -->
        </div>
    </div>

    <!-- Header row with drop-down menu -->
    <div class="header-row">
        <div class="dropdown">
            <button class="dropbtn" disabled>
                Actions
                <span style="float: right" data-qa="header-ActionsMenuName-tab-button-end" class="css-1d11tbi">
                    <span class="css-hg1vx5">
                        <span aria-hidden="true" class="SVGInline">
                            <svg class="SVGInline-svg" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24" focusable="false">
                                <path d="m22 8.34-9.41 9.41a.82.82 0 0 1-1.18 0L2 8.34 3.34 7 12 15.66 20.66 7z"></path>
                            </svg>
                        </span>
                    </span>
                </span>
            </button>
            <div class="dropdown-content">
                <a href="#" id="generateTermSummary">Generate Prevailing Term Summary</a>
                <a href="#" id="generateAmendment">Generate Amendment</a>
                <a href="#" onclick="document.getElementById('generateButton').click();">Refresh Clause Library</a>
                <a href="#" onclick="document.getElementById('generateButton').click();">Sync Data to Ariba</a>
            </div>
        </div>
    </div>

    <!-- Subheader with toggle and filter dropdown -->
    <div class="subheader-row">
        <label for="toggleContractActive">Show Inactive Contracts</label>
        <input type="checkbox" id="toggleContractActive" onchange="toggleContracts(relatedDocuments)">
        <label for="filterDropdown">Filter by Category:</label>
        <select id="filterDropdown" onchange="filterDatapoints(this.value)">
            <option value="">All</option>
            <option value="General">General</option>
            <option value="Legal">Legal</option>
            <option value="Finance">Finance</option>
        </select>
    </div>

    <!-- Term Summary Table -->
    <div id="comparisonTableContainer">
        <!-- Term summary table content will be dynamically added here -->
    </div>

    <!-- Clause Content Table -->
    <div id="clauseContentContainer">
        <!-- Clause content table will be dynamically added here -->
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Version 0.9.011625</p>
    </footer>
</div>


<script>
    // This script is responsible for loading CSS files and extracting URL parameters.
    // It defines two functions: loadCss and extractURLParameter.

    // Function to load CSS file dynamically
    function loadCss(file) {
        var link = document.createElement('link');
        link.href = file;
        link.type = 'text/css';
        link.rel = 'stylesheet';
        document.querySelector('head').appendChild(link);
    }

    // Function to extract URL parameter value
    function extractURLParameter(url, name) {
        return (RegExp(name + '=' + '(.+?)(&|$)').exec(url) || [, null])[1];
    };

    // Get the referrer URL and decode the URL parameters
    var url = document.referrer;
    var aId = decodeURIComponent(extractURLParameter(url, 'aid').replace(/\+/g, " "));
    var docId = decodeURIComponent(extractURLParameter(url, 'Id').replace(/\+/g, " "));
    var env = document.location.href.split("https://")[1].split('.')[0];

    // Load necessary CSS files
    loadCss('https://ux.springcm.com/ux/releases/0.10.5/css/SpringCM.UX.min.css');
    loadCss('https://ux.springcm.com/ux/releases/0.10.5/css/Atlas.Forms.min.css');
    loadCss(`https://${env}.springcm.com/atlas/ThemeCss?aid=${aId}`);
</script>

<script>
    var _scmComponentLibraryPath = 'https://ux.springcm.com/ux/releases/0.10.5/images';
</script>
<script src='https://ux.springcm.com/ux/releases/0.10.5/js/SpringCM.UX.min.js'></script>
<script>
    // Use jQuery in noConflict mode
    var jqueryUX = jQuery.noConflict(true);
</script>

<script type="text/javascript">

var header = document.getElementById("globalHeader");
    if (header != null) {
        var dataModel = header.dataset;
        if (dataModel != null) {
            var model = dataModel.model;
            if (model != null) {
                var accountId = JSON.parse(model).accountGuid;
                if (accountId != null) {
                    var docuSignaId = accountId;
                }
            }
        }
    }

    var searchResults = null;
    var xmlContent = '<Attributes>';

    // Declare the attributesArray and contractNumber globally
    var relatedDocuments = [];  // Assume you populate this with your data
    var contractNumber = '';   // Your contract number

    // This variable will keep track of the toggle state
    var showInactiveContracts = "False";

    $("[ScmFormControl]").bind(Atlas.Forms.SCM_FORM_AFTER_DATA_LOAD, function (e) {

        // Hide top button group and bottom buttons
        $('div.buttonGroup:first').hide();
        $('div.buttonDiv').hide();
        $('div.buttonDiv:last input')[0].value = 'Return to Document';

        if (docId === '') {
            $('div#spinnerOverlay').hide();
            $('div#errorMissingDocID').show();
            $('div.buttonDiv:last').show();
        } else {
            getDocumentAttributes(docId)
                .then(parentAttributes => {
                    const contractNumber = parentAttributes.ContractNumber;

                    // Fetch related documents based on contract number and return the result
                    return fetchRelatedDocuments(contractNumber)
                        .then(relatedDocuments => {
                            return { parentAttributes, relatedDocuments, contractNumber }; // Pass both parentAttributes and relatedDocuments forward
                        });
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    // If there are child document IDs, fetch their attributes
                    if (relatedDocuments.length > 0) {
                        return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                    } else {
                        return { relatedDocuments: [] };
                    }
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    displayContracts(relatedDocuments);

                    var contractDetails = displayContractDetails(relatedDocuments, contractNumber);
                    document.getElementById('contractDetails').innerHTML = contractDetails;

                    return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    var tableHtml = generateComparisonTable(relatedDocuments, contractNumber);
                    document.getElementById('comparisonTableContainer').innerHTML = tableHtml;

                    return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                })
                .then(({ parentAttributes, relatedDocuments, contractNumber }) => {
                    var clauseLanguage = fetchAndFilterClauseContent(searchResults);

                    return { parentAttributes, relatedDocuments, contractNumber }; // Return both parentAttributes and relatedDocuments
                })
                .catch(error => {
                    console.log("Error:", error);
                    $('div#spinnerOverlay').hide();
                    if (error === 'No attribute data') {
                        $('div#errorNoAttributes').show();
                    } else {
                        $('div#errorAPI').show();
                    }
                });

        }
    });

    // Global variable to store clause contents
    var clauseContents = [];

    /**
     * Filters the datapoints in the comparison table based on the selected category.
     * 
     * @param {string} category - The selected category.
     */
    function filterDatapoints(category) {
        // Get all rows in the comparison table
        var comparisonRows = document.querySelectorAll('#comparisonTableContainer tr');

        // Function to filter rows based on category
        function filterRows(rows) {
            rows.forEach(row => {
                var dataCategory = row.getAttribute('data-category');

                // If no category is selected or row doesn't have a data-category attribute, show all rows
                if (category === "" || !dataCategory) {
                    row.style.display = "";
                } else {
                    // Split the data-category attribute into an array of categories
                    var categoriesArray = dataCategory.split(" ");

                    // Check if the selected category is in the array of categories
                    if (categoriesArray.includes(category)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            });
        }

        // Apply filter to the rows
        filterRows(comparisonRows);
    }

    /**
     * Toggles the contract comparison based on the selected toggle state.
     * 
     * @param {Array} relatedDocuments - The array of related documents.
     */
    function toggleContractComparison(relatedDocuments) {
        console.log('Toggle switch clicked');
        console.log('relatedDocuments:', relatedDocuments);

        // Toggle the boolean value
        show = document.getElementById('toggleContractActive').checked ? "True" : "False";

        // Re-generate the table with the current toggle state and attributesArray
        document.getElementById('comparisonTableContainer').innerHTML = generateComparisonTable(relatedDocuments, contractNumber);
    }

    /**
     * Toggles the contracts based on the selected toggle state.
     * 
     * @param {Array} relatedDocuments - The array of related documents.
     */
    function toggleContracts(relatedDocuments) {
        console.log('Toggle switch clicked');
        console.log('relatedDocuments:', relatedDocuments);

        // Toggle the boolean value
        showInactiveContracts = document.getElementById('toggleContractActive').checked ? "True" : "False";

        // Re-generate the table with the current toggle state and attributesArray
        document.getElementById('comparisonTableContainer').innerHTML = generateComparisonTable(relatedDocuments, contractNumber);
    }

    /**
     * Fetches and filters clause content based on the provided attributes array.
     * 
     * @param {Array} attributesArray - The array of attributes.
     * @returns {Promise} - A promise that resolves to the clause contents.
     * @throws {Error} - If there is an error fetching and filtering clause content.
     */
    function fetchAndFilterClauseContent(attributesArray) {
        attributesArray = attributesArray.Result.Items;
        var filteredAttributes = attributesArray.filter(attributes => attributes.Extension === 'sxterm');
        var promises = filteredAttributes.map(attributes => getClauseContent(attributes.Uid));

        return Promise.all(promises)
            .then(clauseContentsArray => {
                clauseContentsArray.forEach((clauseContent, index) => {
                    clauseContents[filteredAttributes[index].DocumentID] = clauseContent;
                });
                displayClauseContent(clauseContents);
                return clauseContents;
            })
            .catch(error => {
                console.error('Error fetching and filtering clause content:', error);
                throw error;
            });
    }

    function displayClauseContent(clauseContents) {
    // Sort by Term (alphabetically) and Date (newest to oldest within each Term)
    clauseContents.sort((a, b) => {
        const termA = a.Name.split(' - ')[0];
        const termB = b.Name.split(' - ')[0];

        // If Terms are the same, sort by EffectiveDate (newest first)
        if (termA === termB) {
            const dateA = a.EffectiveDate ? new Date(a.EffectiveDate.slice(0, 4), a.EffectiveDate.slice(4, 6) - 1, a.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');
            const dateB = b.EffectiveDate ? new Date(b.EffectiveDate.slice(0, 4), b.EffectiveDate.slice(4, 6) - 1, b.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');
            return dateB - dateA; // Newest to oldest
        }

        // Otherwise, sort Terms alphabetically
        return termA.localeCompare(termB);
    });

    // Build the table HTML
    let tableHtml = `
        <h2 class="table-header">Clause Content</h2>
        <table class="clause-term-table">
            <tr><th>Term</th><th>Source</th><th>Content</th><th>Date</th></tr>
    `;

    let lastTerm = ''; // Keep track of the last term to group rows
    clauseContents.forEach((clause) => {
        const [rawTerm, source] = clause.Name.split(' - '); // Split Name into rawTerm and Source
        const term = convertCamelCaseToRegularCase(rawTerm); // Convert rawTerm to Regular Case
        const date = formatDate(clause.EffectiveDate) || 'N/A';

        // Add `new-term` class to the first row of a new group
        const isNewTerm = term !== lastTerm;
        if (isNewTerm) {
            const termRowSpan = clauseContents.filter(c => c.Name.startsWith(rawTerm)).length; // Count rows for the term
            tableHtml += `<tr class="new-term">`;
            tableHtml += `<td rowspan="${termRowSpan}">${term}</td>`;
            lastTerm = term; // Update lastTerm
        } else {
            tableHtml += '<tr>';
        }

        tableHtml += `
            <td>${source || ''}</td>
            <td>${clause.Content || ''}</td>
            <td>${date}</td>
        `;
        tableHtml += '</tr>';
    });

    tableHtml += '</table>';
    document.getElementById('clauseContentContainer').innerHTML = tableHtml;

    return tableHtml;
}


    /**
     * Calculates the number of rows needed for a common name in the clauseContents array.
     * 
     * @param {Array} clauseContents - The array of clause contents.
     * @param {number} currentIndex - The current index in the clauseContents array.
     * @returns {number} The number of rows needed for the common name.
     */
    function getRowCount(clauseContents, currentIndex) {
        let rowCount = 1;
        var currentCommonName = clauseContents[currentIndex].Name.split('-')[0].trim();
        var nextIndex = currentIndex + 1;

        while (nextIndex < clauseContents.length) {
            const nextCommonName = clauseContents[nextIndex].Name.split('-')[0].trim();
            if (nextCommonName === currentCommonName) {
                rowCount++;
                nextIndex++;
            } else {
                break;
            }
        }

        return rowCount;
    }

    /**
     * Retrieves the content of a clause from a SpringCM document.
     * 
     * @returns {Promise} A promise that resolves with the JSON data containing the clause content.
     */
    function getClauseContent(documentID) {
        let downloadURL = "https://apidownloaduatna11.springcm.com/v2/" + docuSignaId + "/documents/" + documentID;
        return new Promise(function (resolve, reject) {
            console.log('Fetching document content from URL:', downloadURL);
            SpringCM.API.get(downloadURL, function (_data) {
                try {
                    const jsonData = JSON.parse(_data);

                    getDocumentAttributes(documentID)
                        .then(documentAttributes => {
                            clauseContents.push({
                                "Name": jsonData['0'].Name,
                                "Content": jsonData['0'].Content,
                                "Notes": jsonData['0'].Notes,
                                "Uid": jsonData['0'].Uid,
                                "DocId": documentAttributes.ParentDocID,
                                "EffectiveDate": documentAttributes.EffectiveDate
                            });
                            resolve(jsonData);
                        })
                        .catch(error => {
                            console.error('Error getting document attributes:', error);
                            reject(error);
                        });
                } catch (error) {
                    console.error('Error parsing JSON data:', error);
                    reject(error);
                }
            });
        });
    }

    /**
     * Fetches the related documents for a given contract number.
     * 
     * @param {string} contractNumber - The contract number.
     * @returns {Promise} - A promise that resolves to the list of related documents.
     * @throws {Error} - If there is an error fetching the related documents.
     */
    function fetchRelatedDocuments(contractNumber) {
        return getAllDocumentIds(contractNumber)
            .then(relatedDocuments => {
                // Do any additional processing if needed
                return relatedDocuments; // Return the list of related documents
            })
            .catch(error => {
                console.error('Error fetching related documents:', error);
                throw error; // Propagate the error for handling in the outer promise chain
            });
    }

    /**
     * Extracts and sorts agreement details from the provided data.
     * 
     * @param {Object} data - The data containing agreement details.
     * @returns {Array} - The sorted array of agreement details.
     */
     function extractAndSortAgreementDetails(data) {
    const result = [];

    console.log('Data:', data);

    // Iterate through each item in the Items array
    data.Result.Items.forEach(item => {
        const clmDetails = item.AttributeGroups["CLM Agreement Details"];
        const contractRecordDetails = item.AttributeGroups["Contract Record"];
        const eMoneyContractDetails = item.AttributeGroups["eMoney Contract Details"];

        console.log('eMoney Contract Details:', eMoneyContractDetails);

        // Check if CLM Agreement Details exists to avoid errors
        if (clmDetails) {
            // Extract specific details from CLM Agreement Details
            const details = {
                DocumentID: item["Uid"], // Add DocumentID
                Name: clmDetails.Name?.Value || 'N/A',
                PartyName: clmDetails["Party Name"]?.Value || 'N/A',
                PartyID: clmDetails["Party ID"]?.Value || 'N/A',
                Type: clmDetails.Type?.Value || 'N/A',
                EffectiveDate: clmDetails["Effective Date"]?.Value || 'N/A',
                ExpirationDate: clmDetails["Expiration Date"]?.Value || 'N/A',
                Value: clmDetails.Value?.Value || 'N/A',
                Requestor: clmDetails.Requestor?.Value || 'N/A',
                PaymentTerms: clmDetails["Payment Terms"]?.Value || 'N/A',
                PaymentDuration: clmDetails["Payment Duration"]?.Value || 'N/A',
                PaymentDurationUnit: clmDetails["Payment Duration Unit"]?.Value || 'N/A',
                PaymentLateFees: clmDetails["Payment Late Fees"]?.Value || 'N/A',
                LimitationLiability: clmDetails["Limitation of Liability"]?.Value || 'N/A',
                Assignable: clmDetails.Assignable?.Value || 'N/A',
                Indemnity: clmDetails.Indemnity?.Value || 'N/A',
                TerminationCause: clmDetails["Termination Cause"]?.Value || 'N/A',
                TerminationConvenience: clmDetails["Termination Convenience"]?.Value || 'N/A',
                ContractIsParent: contractRecordDetails?.["is Parent?"]?.Value || 'N/A',
                ContractIsActive: contractRecordDetails?.["is Active?"]?.Value || 'N/A',
                ContractualTrainingHours: eMoneyContractDetails?.["Contractual Training Hours"]?.Value || 'N/A',
                AdvanceNoticeRequirements: eMoneyContractDetails?.["Price Increase - Advance Notice Requirements"]?.Value || 'N/A',
                FormOfNotice: eMoneyContractDetails?.["Price Increase - Form of Notice"]?.Value || 'N/A',
            };

            // Add extracted details to the result array
            result.push(details);
        }
    });

    // Sort by EffectiveDate (oldest to newest) - original format is 20230224000000
    result.sort((a, b) => {
        const dateA = a.EffectiveDate ? new Date(a.EffectiveDate.slice(0, 4), a.EffectiveDate.slice(4, 6) - 1, a.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');
        const dateB = b.EffectiveDate ? new Date(b.EffectiveDate.slice(0, 4), b.EffectiveDate.slice(4, 6) - 1, b.EffectiveDate.slice(6, 8)) : new Date('9999-12-31');

        if (isNaN(dateA)) return 1; // Treat invalid dateA as greater
        if (isNaN(dateB)) return -1; // Treat invalid dateB as greater

        return dateA - dateB;
    });

    return result;
}

    /**
     * Retrieves all document IDs associated with a given contract number.
     * 
     * @param {string} contractNumber - The contract number.
     * @returns {Promise} - A promise that resolves to an array of document IDs.
     */
    function getAllDocumentIds(contractNumber) {
        return new Promise(function (resolve, reject) {
            const payload = {
                "AttributeFields": [
                    {
                        "Group": "Contract Record",
                        "Field": "Contract Number",
                        "Value": contractNumber
                    }
                ]
            };

            SpringCM.API.post(`/v2/${docuSignaId}/documentsearchtasks/?expand=AttributeGroups`, payload, (data) => {
                if (data.responseText) {
                    reject(data.responseText);
                } else {
                    searchResults = data;
                    const refinedData = extractAndSortAgreementDetails(data);
                    resolve(refinedData);
                }
            });
        });
    }

    /**
     * Retrieves the attributes of a document based on its ID.
     * 
     * @param {string} docId - The ID of the document.
     * @returns {Promise} - A promise that resolves to the document attributes.
     * @throws {Error} - If there is an error retrieving the document attributes.
     */
    function getDocumentAttributes(docId) {
        return new Promise(function (resolve, reject) {
            SpringCM.API.get(`/v2/${docuSignaId}/documents/${docId}?expand=AttributeGroups`, function (data) {
                if (data.responseText) {
                    console.error('Error in response:', data.responseText);
                    reject(data.responseText);
                    return;
                }

                try {
                    var parentFolderHref = data.ParentFolder.Href;
                    var parentFolderId = parentFolderHref.split('/folders/')[1];
                    var attributes = data.AttributeGroups || {};
                    var hasCLMDocumentDetails = attributes['CLM Agreement Details'] !== undefined;

                    var documentAttributes;
                    if (!hasCLMDocumentDetails) {
                        documentAttributes = {
                            "ParentDocID": docId,
                            "ParentFolderID": parentFolderId,
                            "DocumentName": attributes['CLM Document Details']?.['Name']?.Value || '',
                            "EffectiveDate": attributes['CLM Document Details']?.['Effective Date']?.Value || '',
                        };
                    } else {
                        documentAttributes = {
                            "ParentDocID": docId,
                            "ParentFolderID": parentFolderId,
                            "DocumentName": attributes['CLM Agreement Details']?.['Name']?.Value || '',
                            "Type": attributes['CLM Agreement Details']?.['Type']?.Value || '',
                            "EffectiveDate": attributes['CLM Agreement Details']?.['Effective Date']?.Value || '',
                            "ExpirationDate": attributes['CLM Agreement Details']?.['Expiration Date']?.Value || '',
                            "AgreementID": attributes['CLM Agreement Details']?.['Agreement ID']?.Value || '',
                            "PartyID": attributes['CLM Agreement Details']?.['Party ID']?.Value || '',
                            "PartyName": attributes['CLM Agreement Details']?.['Party Name']?.Value || '',
                            "PaymentDuration": attributes['CLM Agreement Details']?.['Payment Duration']?.Value || '',
                            "PaymentDurationUnit": attributes['CLM Agreement Details']?.['Payment Duration Unit']?.Value || '',
                            "PaymentLateFees": attributes['CLM Agreement Details']?.['Payment Late Fees']?.Value || '',
                            "PaymentTerms": attributes['CLM Agreement Details']?.['Payment Terms']?.Value || '',
                            "RenewalNoticePeriod": attributes['CLM Agreement Details']?.['Renewal Notice Period']?.Value || '',
                            "RenewalNoticePeriodUnit": attributes['CLM Agreement Details']?.['Renewal Notice Period Unit']?.Value || '',
                            "RenewalTerm": attributes['CLM Agreement Details']?.['Renewal Term']?.Value || '',
                            "RenewalTermUnit": attributes['CLM Agreement Details']?.['Renewal Term Unit']?.Value || '',
                            "Requestor": attributes['CLM Agreement Details']?.['Requestor']?.Value || '',
                            "Signed": attributes['CLM Agreement Details']?.['Signed']?.Value || '',
                            "TerminationCause": attributes['CLM Agreement Details']?.['Termination Cause']?.Value || '',
                            "TerminationConvenience": attributes['CLM Agreement Details']?.['Termination Convenience']?.Value || '',
                            "TerminationNotice": attributes['CLM Agreement Details']?.['Termination Notice']?.Value || '',
                            "TerminationNoticeDate": attributes['CLM Agreement Details']?.['Termination Notice Date']?.Value || '',
                            "TerminationNoticeUnit": attributes['CLM Agreement Details']?.['Termination Notice Unit']?.Value || '',
                            "LimitationLiability": attributes['CLM Agreement Details']?.['Limitation of Liability']?.Value || '',
                            "Value": attributes['CLM Agreement Details']?.['Value']?.Value || '',
                            "ContractNumber": attributes['Contract Record']?.['Contract Number']?.Value || '',
                            "ContractIsActive": attributes['Contract Record']?.['Is Active?']?.Value || '',
                            "ContractIsParent": attributes['Contract Record']?.['Is Parent?']?.Value || '',
                            "ContractualTrainingHours": attributes['eMoney Contract Details']?.['Contractual Training Hours']?.Value || '',
                            "AdvanceNoticeRequirements": attributes['eMoney Contract Details']?.['Price Increase - Advance Notice Requirements']?.Value || '',
                            "FormOfNotice": attributes['eMoney Contract Details']?.['Price Increase - Form of Notice']?.Value || '',
                        };
                    }
                    console.log('Document Attributes:', documentAttributes);
                    resolve(documentAttributes);
                } catch (error) {
                    console.error('Error processing attributes data:', error);
                    reject(error);
                }
            });
        });
    }

    /**
     * Generates a comparison table based on the provided attributes array and contract number.
     * 
     * @param {Array} attributesArray - An array of contract attributes.
     * @param {string} contractNumber - The contract number.
     * @returns {string} - The HTML content of the comparison table.
     */
    function generateComparisonTable(attributesArray, contractNumber) {
        console.log('Generating Comparison Table with attributesArray:', attributesArray);
        var tableHtml = `<h2 class="table-header">Term Summary Table</h2>`;

        // Remove any rows where parent.Name contains "sxterm"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("sxterm"));

        // Remove any rows where parent.Name contains "Prevailing"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("Prevailing"));

        // Filter agreements based on the toggle state
        if (showInactiveContracts === "False") {
            attributesArray = attributesArray.filter(parent => parent.ContractIsActive === "True");
        }

        // Check if the array has at least one item
        if (!attributesArray || attributesArray.length === 0) {
            return '<p>No data available.</p>';
        }

        // The parent attributes are the first item in the array
        var parentAttributes = attributesArray[0];
        var childAttributesArray = attributesArray.slice(1); // The rest are child attributes

        tableHtml += '<table>';
        tableHtml += '<tr><th>Datapoint</th><th>Parent</th>';

        // Add column headers for each child document
        childAttributesArray.forEach((_, index) => {
            tableHtml += `<th>Child ${index + 1}</th>`;
        });
        tableHtml += '<th>Prevailing Terms</th></tr>';

        // Define a mapping between keys and categories
        const categoryMapping = {
            'Name': ['General', 'Legal', 'Finance'],
            'EffectiveDate': ['General', 'Legal', 'Finance'],
            'ExpirationDate': ['General', 'Legal', 'Finance'],
            'Value': ['Finance'],
            'AgreementType': ['Legal'],
            'Requestor': ['General'],
            'PaymentTerms': ['Finance'],
            'PaymentDuration': ['Finance'],
            'PaymentDurationUnit': ['Finance'],
            'PaymentLateFees': ['Finance'],
            'LimitationOfLiability': ['Legal'],
            'Assignable': ['Legal'],
            'Indemnity': ['Legal'],
            'TerminationCause': ['Legal'],
            'TerminationConvenience': ['Legal'],
            'ContractIsParent': ['General'],
            'ContractIsActive': ['General'],
            'ContractualTrainingHours': ['General'],
            'AdvanceNoticeRequirements': ['General'],
            'FormOfNotice': ['General'],
            // Add other mappings as needed
        };

        // Parse parent attributes
        var parsedParentAttributes = parseAttributes(parentAttributes);

        // Get all unique keys from parent attributes and all child attributes
        var allKeys = new Set(Object.keys(parsedParentAttributes));
        childAttributesArray.forEach(childAttributes => {
            var parsedChildAttributes = parseAttributes(childAttributes);
            // Merge child attributes keys
            allKeys = new Set([...allKeys, ...Object.keys(parsedChildAttributes)]);
        });

        // List of keys to skip
        const keysToSkip = ['DocumentID', 'PartyName', 'ParentDocID', 'ParentFolderID', 'AgreementID', 'PartyID', 'ChildAgreementIds', 'ParentAgreementId', 'Signed'];

        // Generate table rows for parent and each child
        allKeys.forEach(key => {
            // Skip if the key is in the keysToSkip array
            if (keysToSkip.includes(key)) {
                return;
            }

            // Get the parent value and replace 'N/A' with an empty string
            var parentValue = parsedParentAttributes[key] || '';
            parentValue = parentValue === 'N/A' ? '' : parentValue;

            var childValues = [];
            var prevailingTerm = '';

            // Initialize sum for 'Value' key
            var sum = 0;

            // Convert to USD Currency if the key is 'Value'
            if (key === 'Value') {
                // Try to parse parentValue as a number
                sum += parseFloat(parentValue) || 0;
                parentValue = formatCurrency(parentValue);
            }

            // Format EffectiveDate and ExpirationDate
            if (key === 'EffectiveDate' || key === 'ExpirationDate') {
                parentValue = formatDate(parentValue);
            }

            childAttributesArray.forEach(childAttributes => {
                var childValue = (childAttributes[key] || '').toString();
                // Replace 'N/A' with an empty string
                childValue = childValue === 'N/A' ? '' : childValue;

                // Convert to USD Currency if the key is 'Value'
                if (key === 'Value') {
                    // Try to parse childValue as a number
                    sum += parseFloat(childValue) || 0;
                    childValue = formatCurrency(childValue);
                }

                // Format EffectiveDate and ExpirationDate
                if (key === 'EffectiveDate' || key === 'ExpirationDate') {
                    childValue = formatDate(childValue);
                }

                childValues.push(childValue);
            });

            // Determine prevailingTerm based on the sum of 'Value'
            if (key === 'Value') {
                prevailingTerm = formatCurrency(sum);
            } else {
                prevailingTerm = parentValue;

                // Update prevailingTerm based on child values
                for (var i = childValues.length - 1; i >= 0; i--) {
                    if (childValues[i]) {
                        prevailingTerm = childValues[i];
                        break;
                    }
                }
            }

            // Replace 'N/A' with empty string for prevailingTerm
            prevailingTerm = prevailingTerm === 'N/A' ? '' : prevailingTerm;

            if (key === 'Name' || key === 'Type') {
                prevailingTerm = '';
            }

            // Get the category for the current key
            var categories = categoryMapping[key] || [];
            var dataCategoryAttr = categories.length > 0 ? `data-category="${categories.join(' ')}"` : '';

            // Wrap prevailing term in <strong> tags
            var parentValueHtml = parentValue === prevailingTerm ? `<strong>${parentValue}</strong>` : parentValue;
            var childValuesHtml = childValues.map(value => value === prevailingTerm ? `<strong>${value}</strong>` : value);
            var prevailingTermHtml = `<strong>${prevailingTerm}</strong>`;

            // Generate the row with the data-category attribute
            tableHtml += `<tr ${dataCategoryAttr}><td>${convertCamelCaseToRegularCase(key)}</td><td>${parentValueHtml}</td>${childValuesHtml.map(value => `<td>${value}</td>`).join('')}<td>${prevailingTermHtml}</td></tr>`;

            // Add to XML content if there's content
            if (prevailingTerm) {
                xmlContent += `  <${key}>${prevailingTerm}</${key}>`;
            }
        });

        // Close the XML content
        xmlContent += `<ParentDocID>${parsedParentAttributes['ParentDocID']}</ParentDocID>`;
        xmlContent += `<ParentFolderID>${parsedParentAttributes['ParentFolderID']}</ParentFolderID>`;
        xmlContent += `<PartyID>${parsedParentAttributes['PartyID']}</PartyID>`;
        xmlContent += '</Attributes>';

        tableHtml += '</table>';
        return tableHtml;
    }

    /**
     * Function to display contracts dynamically in a tree view.
     * 
     * @param {Array} attributesArray - An array of contract attributes.
     */
    function displayContracts(attributesArray) {
        const container = document.getElementById('contractDisplay');

        // remove any rows were parent.Name contains "sxterm"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("sxterm"));

        // Remove any rows where parent.Name contains "Prevailing"
        attributesArray = attributesArray.filter(parent => !parent.Name.includes("Prevailing"));

        console.log('Attributes Array:', attributesArray);

        // update global relatedDocuments variable
        relatedDocuments = attributesArray;

        // Clear existing content before adding new content
        container.innerHTML = '<h2>Contract Hierarchy</h2>';
        var parent = attributesArray[0];
        var children = attributesArray.slice(1); // The rest are child attributes

        // Create the parent contract header
        const parentDiv = document.createElement('div');
        parentDiv.classList.add('contract-header');
        parentDiv.innerHTML = `
                    <div>
                        <strong class="contract-name">${parent.Name}</strong> - ${parent.Type} - ${formatDate(parent.EffectiveDate)} | <a href='https://uatna11.springcm.com/atlas/Documents/View?aid=19447&Id=${parent.DocumentID}' target='_blank'>Link</a>
                    </div>
                    <div class="contract-record-indicator">
                        ${children.length} child records
                    </div>
                `;
        container.appendChild(parentDiv);

        // Create the children container
        const childrenContainer = document.createElement('div');
        childrenContainer.classList.add('contract-children');
        const iconGraphic = `<img src="https://cdn3.iconfinder.com/data/icons/seo-search-engine-optimization/64/seo_web_Search_Engine_Optimization_hierarchy_map_navigation_sitemap_orgnization_tree_site-512.png" width=16 height=16>`;
        children.forEach(child => {
            const childDiv = document.createElement('div');
            childDiv.innerHTML = `
                <strong>${child.Name}</strong> - ${child.Type} - ${formatDate(child.EffectiveDate)} - 
                <a href='https://uatna11.springcm.com/atlas/Documents/View?aid=19447&Id=${child.DocumentID}' target='_blank'>Link</a> | 
                ${child.Requestor} | 
                ${child.ContractIsParent === 'True' ? `<a href='https://uatna11.springcm.com/atlas/Documents/View?aid=19447&Id=${child.DocumentID}' target='_blank'>${iconGraphic}</a>` : ''}
                `;
            childrenContainer.appendChild(childDiv);
        });

        container.appendChild(childrenContainer);

        // Add event listener to toggle .expanded class
        parentDiv.addEventListener('click', () => {
            childrenContainer.classList.toggle('expanded');
        });
    }

    /**
     * Displays contract details.
     * 
     * @param {HTMLElement} parent - The parent element where the contract details will be displayed.
     * @param {string} contractNumber - The contract number to be displayed.
     * @returns {string} - The HTML content of the contract details.
     */
    function displayContractDetails(parent, contractNumber) {
        // Clear existing content before adding new content
        var contractDetailsHtml = `<h1> ${contractNumber}</h1> <strong>Party Name:</strong> ${parent[0].PartyName} <br/> <strong>Account Owner:</strong> ${parent[0].Requestor}`;

        return contractDetailsHtml;
    }

    /**
     * Function to call the Workflow API.
     * 
     * @param {Event} event - The event object.
     * @param {string} endpoint - The endpoint to call.
     * @returns {Promise} - A promise that resolves with the response from the API call.
     * @throws {Error} - If xmlContent is not a string.
     */
    function callWorkflowApi(event, endpoint) {

        // Prevent the default form submission behavior
        if (event) {
            event.preventDefault();
        }

        // Ensure xmlContent is a string
        if (typeof xmlContent !== 'string') {
            throw new Error('xmlContent is not a string');
        }

        // Escape and send XML content
        var escapedXmlContent = xmlContent.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        var body = JSON.stringify({
            Name: endpoint,
            Params: escapedXmlContent
        });

        return new Promise(function (resolve, reject) {
            SpringCM.API.post(`/v2/${docuSignaId}/workflows`, body, function (response) {
                // Log the response to debug
                if (response && response.status === 200) {
                    resolve(response);
                }
                else if (response) {
                    alert(endpoint, ' initiated.')
                }
                else {
                    // Log the response in case of error
                    console.error('Error Response:', response);
                    reject(new Error('Failed to post XML content'));
                }
            }).catch(function (error) {
                // Log errors if any
                console.error('Request Error:', error);
                reject(error);
            });
        });

    }

    function parseAttributes(attributes) {
        var parsedAttributes = {};
        for (var key in attributes) {
            if (attributes.hasOwnProperty(key)) {
                // Assuming attributes[key] is a primitive value
                parsedAttributes[key] = attributes[key] || '';
            }
        }
        return parsedAttributes;
    }

    function formatCurrency(value) {
        if (isNaN(value)) return '';
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        // Extract year, month, and day from the dateString
        var year = dateString.substring(0, 4);
        var month = dateString.substring(4, 6);
        var day = dateString.substring(6, 8);

        // Format date as MM/DD/YYYY
        return `${month}/${day}/${year}`;
    }

    /**
     * Converts a CamelCase string to Regular Case (e.g., PaymentLateFees -> Payment Late Fees).
     * @param {string} str - The CamelCase string.
     * @returns {string} - The converted Regular Case string.
     */
    function convertCamelCaseToRegularCase(str) {
        return str
            .replace(/([a-z])([A-Z])/g, '$1 $2') // Add a space before each uppercase letter following a lowercase letter
            .replace(/^./, char => char.toUpperCase()); // Capitalize the first letter
    }


    // Define the workflow names
    var workflowNamePrevailingTermSummary = 'Prevailing Term Summary';
    var workflowNameGenerateAmendment = 'Prevailing Term Amendment';

    // Add event listener for generating term summary
    document.getElementById('generateTermSummary').addEventListener('click', function (event) {
        callWorkflowApi(event, workflowNamePrevailingTermSummary);
    });

    // Add event listener for generating amendment
    document.getElementById('generateAmendment').addEventListener('click', function (event) {
        callWorkflowApi(event, workflowNameGenerateAmendment);
    });

</script>